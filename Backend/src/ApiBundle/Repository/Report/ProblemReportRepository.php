<?php

namespace ApiBundle\Repository\Report;

use ApiBundle\Entity\Branch;
use ApiBundle\Entity\Report\EndOfShiftReport;

/**
 * ProblemReportRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ProblemReportRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * Get the list reports which were made in shift.
     * @param EndOfShiftReport $report
     * @return mixed
     */
    public function getProblemReportsByEndOfShiftReport($report) {
        $qb = $this->createQueryBuilder('ProblemReport');
        $qb->where('TIMESTAMPDIFF(second, :created, ProblemReport.created) >= 0 AND TIMESTAMPDIFF(second, ProblemReport.created, :updated) >= 0')
            ->setParameter('created', $report->getCreated())->setParameter('updated', $report->getUpdated());
        $query = $qb->getQuery();
        return $query->getResult();
    }

    /**
     * Get the list reports which were made in together by branch.
     * @param Branch $branch
     * @param $param
     * @return mixed
     */
    public function getProblemReportByParam(Branch $branch, $param)
    {
        $qb = $this->createQueryBuilder('ProblemReport');

        $qb->innerJoin('ProblemReport.branch_shift', 'bs')
            ->innerJoin('bs.branch', 'b');
        $qb->andWhere('b.id = :branch')->setParameter(':branch', $branch);

        if(!empty($param['date'])) {
            $qb->andWhere('DATE(:date) = DATE(ProblemReport.created)')->setParameter(':date', $param['date']);
        }

        if(!empty($param['branch_station'])) {
            $qb->andWhere(':branch_station = ProblemReport.branch_station')->setParameter(':branch_station', $param['branch_station']);
        }

        if(!empty($param['branch_shift'])) {
            $qb->andWhere(':branch_shift = ProblemReport.branch_shift')->setParameter(':branch_shift', $param['branch_shift']);
        }

        $query = $qb->getQuery();
        return $query->getResult();
    }
}
